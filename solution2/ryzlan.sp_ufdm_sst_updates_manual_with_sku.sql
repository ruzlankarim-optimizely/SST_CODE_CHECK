CREATE OR REPLACE FUNCTION ryzlan.sp_ufdm_sst_updates_manual()
 RETURNS void
 LANGUAGE plpgsql
AS $function$ BEGIN --take a backup into archive db for comparison before and after
  drop table if exists ryzlan.archive_ls_sst;
create table ryzlan.archive_ls_sst as
select *
from ryzlan.sku_sst;
--remove fopti duplicates
perform ryzlan.sp_ufdm_remove_fopti_dups_sst_manual_with_sku();
--select public.sp_ufdm_remove_fopti_dups_sst_manual();
--update product family
update ryzlan.sku_sst
set product_family = 'Recurring: Cloud: Content Cloud: Content PaaS',
  modified_comments = 'PF updated to PAAS from SAAS'
where product_family = 'Recurring: Cloud: Content Cloud: Content SaaS';
--insert additional records into sst
drop table if exists temp_tat_delete_aninda_8_june_insert;
create temporary table temp_tat_delete_aninda_8_june_insert as
select '' as "snapshot_date",
  '' as "ultimate_parent_id",
  '' as "ultimate_parent_name",
  '' as "duns_name",
  '' as "duns_number",
  '' as "parent_duns_name",
  '' as "parent_duns_number",
  '' as "domesticultimatedunsnumber",
  '' as "globalultimatedunsnumber",
  '' as "c_name",
  '' as "parent_ns_id",
  '' as "end_ns_id",
  '' as "name",
  '' as "parent_name",
  '' as "end_name",
  '' as "mcid",
  '' as "parent_mcid",
  '' as "end_mcid",
  '' as "subsidiary_entity_name",
  '' as "overage_flag",
  '' as "segment",
  '' as "region",
  '' as "product_family",
  '' as "base_currency",
  '' as "cc_fx_rate",
  '' as "fx_date",
  '' as "arr",
  '' as "baseline_arr_local_currency",
  '' as "dw_modified_date",
  '' as "dw_created_date",
  '' as "parent_sf_id",
  '' as "parent_sf_name",
  '' as "sku"
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'Branded Online, Inc.',
  '66914567',
  '[NULL]',
  '[NULL]',
  '66914567',
  '66914567',
  'C6617',
  'C6617',
  '[NULL]',
  'Honeywell PPE',
  'Honeywell PPE',
  '[NULL]',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '61 800',
  '61 800',
  '[NULL]',
  '[NULL]',
  '0014J00000bNc51QAC',
  'Honeywell PPE',''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'Branded Online, Inc.',
  '66914567',
  '[NULL]',
  '[NULL]',
  '66914567',
  '66914567',
  'C6617',
  'C6617',
  '[NULL]',
  'Honeywell PPE',
  'Honeywell PPE',
  '[NULL]',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '61 800',
  '61 800',
  '[NULL]',
  '[NULL]',
  '0014J00000bNc51QAC',
  'Honeywell PPE',
''
union all
select '2022-03-31',
  '[NULL]',
  '[NULL]',
  'Branded Online, Inc.',
  '66914567',
  '[NULL]',
  '[NULL]',
  '66914567',
  '66914567',
  'C6617',
  'C6617',
  '[NULL]',
  'Honeywell PPE',
  'Honeywell PPE',
  '[NULL]',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '897145ea-48ca-89c6-9284-cb3e8bd3c17e',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '61 800',
  '61 800',
  '[NULL]',
  '[NULL]',
  '0014J00000bNc51QAC',
  'Honeywell PPE',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'Avonova Holding AB',
  '778212295',
  '[NULL]',
  '[NULL]',
  '778212295',
  '778212295',
  'C2917',
  'C2917',
  '[NULL]',
  'Avonova AB',
  'Avonova AB',
  '[NULL]',
  'f12efaae-9a1d-e611-812d-c4346baccd14',
  'f12efaae-9a1d-e611-812d-c4346baccd14',
  '[NULL]',
  'Episerver AB',
  'N',
  'Mid-Market',
  'EMEA',
  'Recurring: Cloud: Content Cloud: Content PaaS',
  'SEK',
  '0,095902',
  '2022-12-31',
  '34 524,76',
  '360 000',
  '[NULL]',
  '[NULL]',
  '0014J00000JqINKQA3',
  'Avonova AB',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-03-31',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-04-30',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-05-31',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-06-30',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-07-31',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-08-31',
  '[NULL]',
  '[NULL]',
  'The American Society of Civil Engineers',
  '71034979',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '71034979',
  'C68',
  'C68',
  '[NULL]',
  'American Society of Civil Engineers',
  'American Society of Civil Engineers',
  '[NULL]',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '749fa945-ade4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '34 129,24',
  '34 129,24',
  '[NULL]',
  '[NULL]',
  '0014J00000JqEWWQA3',
  'American Society of Civil Engineers',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'MORETON BAY REGIONAL COUNCIL',
  '759388171',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '759388171',
  'C740',
  'C740',
  '[NULL]',
  'Moreton Bay Regional Council',
  'Moreton Bay Regional Council',
  '[NULL]',
  '132433dd-efe5-e411-9afb-0050568d2da8',
  '132433dd-efe5-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Enterprise',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '19 002,28',
  '27 924',
  '[NULL]',
  '[NULL]',
  '0014J00000JqAruQAF',
  'Moreton Bay Regional Council',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-03-31',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-04-30',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-05-31',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-06-30',
  '[NULL]',
  '[NULL]',
  'La Opera',
  '98683529',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '98683529',
  'C587',
  'C587',
  '[NULL]',
  'LA Opera',
  'LA Opera',
  '[NULL]',
  'b5146f8f-e473-e111-968f-0050568d002c',
  'b5146f8f-e473-e111-968f-0050568d002c',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'North America',
  'Non-Recurring: Perpetual License',
  'USD',
  '1',
  '2022-12-31',
  '8 017,76',
  '8 017,76',
  '[NULL]',
  '[NULL]',
  '0014J00000JqGOHQA3',
  'LA Opera',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-03-31',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-04-30',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-05-31',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-06-30',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-07-31',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-08-31',
  '[NULL]',
  '[NULL]',
  'WS GROUP PTE. LTD.',
  '595326300',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '595326300',
  'C787',
  'C787',
  '[NULL]',
  'WS Group Pte Ltd',
  'WS Group Pte Ltd',
  '[NULL]',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  'a574e1c4-34e4-e411-9afb-0050568d2da8',
  '[NULL]',
  'Episerver Inc.',
  'N',
  'Mid-Market',
  'APAC',
  'Non-Recurring: Perpetual License',
  'AUD',
  '0,6805',
  '2022-12-31',
  '5 012,86',
  '7 366,44',
  '[NULL]',
  '[NULL]',
  '0014J00000JqFs3QAF',
  'WS Group Pte Ltd',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'A-HEAT Allied Heat Exchange Technology AG',
  '344418194',
  '[NULL]',
  '[NULL]',
  '344418194',
  '344418194',
  'C5395',
  'C5395',
  '[NULL]',
  'Spark Radiance GmbH',
  'C5395 Spark Radiance GmbH',
  '[NULL]',
  '3eea6afb-5a3d-a754-f496-43224112b3b7',
  '3eea6afb-5a3d-a754-f496-43224112b3b7',
  '[NULL]',
  'Episerver GmbH',
  'N',
  'Mid-Market',
  'EMEA',
  'Recurring: Cloud: Commerce Cloud: B2C Commerce (incl. Headless)',
  'EUR',
  '1,072041',
  '2022-12-31',
  '85 548,87',
  '79 800',
  '[NULL]',
  '[NULL]',
  '0014J00000W7kbBQAR',
  'Spark Radiance GmbH',
''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'A-HEAT Allied Heat Exchange Technology AG',
  '344418194',
  '[NULL]',
  '[NULL]',
  '344418194',
  '344418194',
  'C5395',
  'C5395',
  '[NULL]',
  'Spark Radiance GmbH',
  'C5395 Spark Radiance GmbH',
  '[NULL]',
  '3eea6afb-5a3d-a754-f496-43224112b3b7',
  '3eea6afb-5a3d-a754-f496-43224112b3b7',
  '[NULL]',
  'Episerver GmbH',
  'N',
  'Mid-Market',
  'EMEA',
  'Recurring: Cloud: Commerce Cloud: B2C Commerce (incl. Headless)',
  'EUR',
  '1,072041',
  '2022-12-31',
  '85 548,87',
  '79 800',
  '[NULL]',
  '[NULL]',
  '0014J00000W7kbBQAR',
  'Spark Radiance GmbH',
''
union all
select '2022-01-31',
  '[NULL]',
  '[NULL]',
  'Arm The Animals LLC',
  '4513048',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '4513048',
  'C6751',
  'C6751',
  '[NULL]',
  'Arm The Animals Clothing',
  'Arm The Animals Clothing',
  '[NULL]',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '138 697,62',
  '138 697,62',
  '[NULL]',
  '[NULL]',
  '0014J00000bNYQ9QAO',
  'Arm The Animals Clothing',
''
union all
select '2022-02-28',
  '[NULL]',
  '[NULL]',
  'Arm The Animals LLC',
  '4513048',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '4513048',
  'C6751',
  'C6751',
  '[NULL]',
  'Arm The Animals Clothing',
  'Arm The Animals Clothing',
  '[NULL]',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '138 697,62',
  '138 697,62',
  '[NULL]',
  '[NULL]',
  '0014J00000bNYQ9QAO',
  'Arm The Animals Clothing',
''
union all
select '2022-03-31',
  '[NULL]',
  '[NULL]',
  'Arm The Animals LLC',
  '4513048',
  '[NULL]',
  '[NULL]',
  '[NULL]',
  '4513048',
  'C6751',
  'C6751',
  '[NULL]',
  'Arm The Animals Clothing',
  'Arm The Animals Clothing',
  '[NULL]',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '6d9e25c5-f5de-cad0-2bce-2bad47a49931',
  '[NULL]',
  'Zaius',
  'N',
  'Mid-Market',
  'North America',
  'Recurring: Cloud: Intelligence Cloud: CDP (incl. Visitor Intelligence)',
  'USD',
  '1',
  '2022-12-31',
  '138 697,62',
  '138 697,62',
  '[NULL]',
  '[NULL]',
  '0014J00000bNYQ9QAO',
  'Arm The Animals Clothing',
'';
delete from temp_tat_delete_aninda_8_june_insert
where snapshot_date = '';
insert into ryzlan.sku_sst (
    snapshot_date,
    duns_name,
    duns_number,
    globalultimatedunsnumber,
    c_name,
    parent_ns_id,
    name,
    parent_name,
    mcid,
    parent_mcid,
    subsidiary_entity_name,
    overage_flag,
    segment,
    region,
    product_family,
    base_currency,
    cc_fx_rate,
    fx_date,
    arr,
    baseline_arr_local_currency,
    parent_sf_id,
    parent_sf_name
  )
select snapshot_date::date,
  duns_name,
  duns_number,
  globalultimatedunsnumber,
  c_name,
  parent_ns_id,
  name,
  parent_name,
  mcid,
  parent_mcid,
  subsidiary_entity_name,
  overage_flag,
  segment,
  region,
  product_family,
  base_currency,
  replace(cc_fx_rate, ',', '.')::numeric,
  fx_date::date,
  replace(replace(arr, ' ', ''), ',', '.')::numeric,
  replace(
    replace(baseline_arr_local_currency, ' ', ''),
    ',',
    '.'
  )::numeric,
  parent_sf_id,
  parent_sf_name
from temp_tat_delete_aninda_8_june_insert;
--#####################################################
--UPDATE BASELINE CURRENCY
--#####################################################
DROP TABLE IF EXISTS TEMP_BASECURRENCY;
CREATE TEMP TABLE TEMP_BASECURRENCY AS
select mcid,
  snapshot_date,
  base_currency,
  arr,
  baseline_arr_local_currency,
  product_family,
  cc_fx_rate,
  rank() over (
    partition by mcid
    order by snapshot_date desc
  ) as latest_currency,
  NULL AS DUPS,
  NULL AS base_currency_NEW
from ryzlan.sku_sst
WHERE base_currency IS NOT NULL
  AND coalesce(ARR, 0) > 0;
UPDATE TEMP_BASECURRENCY
SET base_currency_NEW = 'USD',
  DUPS = '1'
WHERE MCID IN (
    select mcid
    from TEMP_BASECURRENCY
    where latest_currency = 1
    group by mcid
    having count(distinct base_currency) > 1
  );
UPDATE TEMP_BASECURRENCY A
SET base_currency_NEW = B.base_currency
FROM TEMP_BASECURRENCY B
WHERE 1 = 1
  AND B.latest_currency = 1
  AND A.MCID = B.MCID
  AND A.MCID NOT IN (
    select mcid
    from TEMP_BASECURRENCY
    where latest_currency = 1
    group by mcid
    having count(distinct base_currency) > 1
  );
--UPDATE SST_V22
with temp as (
  SELECT distinct a.mcid,
    a.base_currency_NEW,
    fx_rate
  FROM TEMP_BASECURRENCY A
    JOIN ufdm_grey.arr_fx_rates FX ON A.base_currency_NEW = FX.trans_cur
    AND FX.fx_type = 'ccfx'
  WHERE 1 = 1
    AND base_currency_NEW IS NOT NULL
)
update ryzlan.sku_sst t1
set baseline_arr_local_currency = t1.arr / t2.fx_rate,
  base_currency = t2.base_currency_NEW,
  cc_fx_rate = t2.fx_rate,
  modified_comments = concat(
    coalesce(modified_comments, ';'),
    'base currency update from ',
    t1.base_currency::Text,
    ' to ',
    t2.base_currency_NEW::Text,
    'baseline_arr_local_currency updated from ',
    t1.baseline_arr_local_currency,
    ' to ',
(t1.arr / t2.fx_rate)::Text
  )
from temp t2
where t1.mcid = t2.mcid
  and t1.base_currency <> t2.base_currency_NEW
  and t1.base_currency is not null
  and coalesce(t1.arr, 0) > 0;
--UPDATE baseline vs arr discrepencies
update ryzlan.sku_sst a
set baseline_arr_local_currency = (a.arr / b.fx_rate),
  modified_comments = concat(
    coalesce(modified_comments, ';'),
    'lcu update from ',
    baseline_arr_local_currency::Text,
    ' to ',
(a.arr / b.fx_rate)::Text
  )
from (
    select trans_cur,
      fx_rate
    from ufdm_grey.arr_fx_rates
    where fx_type = 'ccfx'
  ) b
where a.base_currency = b.trans_cur
  and coalesce(a.arr, 0) - (
    coalesce(a.baseline_arr_local_currency, 0) * b.fx_rate
  ) not between -1 and 1;
--APPLY ADHOC FIXES
update ryzlan.sku_sst
set baseline_arr_local_currency = arr
where mcid = '30f35937-33a5-e811-814d-70106fa55dc1'
  and snapshot_date between '2022-09-30' and '2023-03-31'
  and baseline_arr_local_currency = '24671.975000000006'
  and base_currency = 'USD'
  and arr > 0;
update ryzlan.sku_sst
set baseline_arr_local_currency = arr
where mcid = 'f537f1ea-f32b-a960-a59d-3138a1530783'
  and snapshot_date between '2022-09-30' and '2022-12-31'
  and baseline_arr_local_currency = '0'
  and base_currency = 'USD';
update ryzlan.sku_sst
set baseline_arr_local_currency = 140053.97196 / 0.0959021
where mcid = '06e01a1e-20e5-e411-9afb-0050568d2da8'
  and snapshot_date between '2022-07-31' and '2022-12-31'
  and arr > 0;
--Manual corrections
update ryzlan.sku_sst
set baseline_arr_local_currency = arr / cc_fx_rate
where mcid = '5a8496b5-17ed-06d0-9cf9-664634366539'
  and snapshot_date between '2021-07-31' and '2021-12-31';
update ryzlan.sku_sst
set baseline_arr_local_currency = arr / cc_fx_rate
where mcid = '07454906-409e-dfdb-091a-69fa44d8c612'
  and snapshot_date between '2021-08-31' and '2021-10-31';
update ryzlan.sku_sst
set cc_fx_rate = '0.0959021'
where mcid = 'e936a4b0-1eaa-db11-8952-0018717a8c82'
  and snapshot_date between '2022-04-30' and '2022-12-31';
update ryzlan.sku_sst
set baseline_arr_local_currency = arr / cc_fx_rate
where mcid = 'e936a4b0-1eaa-db11-8952-0018717a8c82'
  and snapshot_date between '2022-04-30' and '2022-12-31';
update ryzlan.sku_sst
set cc_fx_rate = '0.0959021'
where mcid = '842c8a6e-b7ba-dd11-9f9c-0018717a8c82'
  and snapshot_date = '2022-12-31'
  and product_family in (
    'Recurring: Cloud: Other Bookings: Other Bookings',
    'Non-Recurring: Perpetual License',
    'Recurring: Cloud: Other Bookings: Other Bookings'
  );
update ryzlan.sku_sst
set baseline_arr_local_currency = arr / cc_fx_rate
where mcid = '842c8a6e-b7ba-dd11-9f9c-0018717a8c82'
  and snapshot_date = '2022-12-31'
  and product_family in (
    'Recurring: Cloud: Other Bookings: Other Bookings',
    'Non-Recurring: Perpetual License',
    'Recurring: Cloud: Other Bookings: Other Bookings'
  );
--APPLY SHELL CUSTOMER FIXES
--select snapshot_date,arr,baseline_arr_local_currency,cohort_actions,product_family from ufdm.sst where mcid= '8ef0bf48-f16c-72ce-6356-41f25b5aaaf2' and snapshot_date between '2022-09-30' and '2023-07-31' and arr > 0
update ryzlan.sku_sst
set arr = '218333.33',
  baseline_arr_local_currency = '218333.33',
  cohort_actions = concat(
    cohort_actions::text,
    '==>arr and lcu updated from ',
    arr::text
  )
where mcid = '8ef0bf48-f16c-72ce-6356-41f25b5aaaf2'
  and snapshot_date between '2022-09-30' and '2022-09-30'
  and arr > 0;
update ryzlan.sku_sst
set arr = '218333.33',
  baseline_arr_local_currency = '218333.33',
  cohort_actions = concat(
    cohort_actions::text,
    '==>arr and lcu updated from ',
    arr::text
  )
where mcid = '8ef0bf48-f16c-72ce-6356-41f25b5aaaf2'
  and snapshot_date between '2022-10-31' and '2022-12-31'
  and arr > 0;
update ryzlan.sku_sst
set arr = '252333.33',
  baseline_arr_local_currency = '252333.33',
  cohort_actions = concat(
    cohort_actions::text,
    '==> arr and lcu updated from ',
    arr::text
  )
where mcid = '8ef0bf48-f16c-72ce-6356-41f25b5aaaf2'
  and snapshot_date between '2023-01-31' and '2023-06-30'
  and arr > 0;
--manual product family updates
update ryzlan.sku_sst
set product_family = 'Recurring: Cloud: Commerce Cloud: B2B Commerce (incl. Headless)',
  modified_comments = 'Updated product family from blank' --select product_family,* from ufdm.sst
where mcid = 'ed677631-ecac-b556-c906-c90ccdaf08e9'
  and snapshot_date = '2023-06-30'
  and coalesce(product_family, '') = '';
update ryzlan.sku_sst
set product_family = 'Recurring: Cloud: Other Bookings: Other Bookings',
  modified_comments = 'Updated product family from blank' --select product_family,* from ufdm.sst
where mcid = 'c1e9aabe-8f1f-e311-9350-0050568d002c'
  and snapshot_date between '2021-01-31' and '2021-12-31'
  and coalesce(product_family, '') = '';
update ryzlan.sku_sst
set product_family = 'Web',
  modified_comments = 'Updated product family from blank' --select product_family,* from ufdm.sst
where mcid = '0e23d4be-9c06-8d05-e24e-58541d2655dd'
  and snapshot_date between '2022-07-31' and '2022-11-30'
  and coalesce(product_family, '') = '';
END;
$function$
;
